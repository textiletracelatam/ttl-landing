---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { readFileSync } from "node:fs";
import { resolveRegions, regionDisplayLabels } from "../regions";

const normativas = (await getCollection("normativas")).sort(
  (a, b) => a.data.order - b.data.order
);

const mapSvg = readFileSync("public/world-map.svg", "utf-8");

const categoryColors: Record<string, { bg: string; text: string }> = {
  Ambiental: {
    bg: "bg-emerald-50 dark:bg-emerald-500/10",
    text: "text-emerald-700 dark:text-emerald-400",
  },
  Laboral: {
    bg: "bg-blue-50 dark:bg-blue-500/10",
    text: "text-blue-700 dark:text-blue-400",
  },
  Comercial: {
    bg: "bg-amber-50 dark:bg-amber-500/10",
    text: "text-amber-700 dark:text-amber-400",
  },
};

const defaultColor = {
  bg: "bg-neutral-50 dark:bg-neutral-500/10",
  text: "text-neutral-700 dark:text-neutral-400",
};
---

<Layout title="Normativas">
  <div class="bg-background pb-24 sm:pb-32">
    <!-- Header -->
    <div class="px-6 pt-8 pb-16 lg:px-8">
      <div class="mx-auto max-w-2xl pt-12 text-center sm:pt-20">
        <h1 class="text-5xl font-semibold tracking-tight text-neutral-900 sm:text-7xl dark:text-white">Normativas</h1>
        <p class="mt-8 text-lg font-medium text-pretty text-neutral-500 sm:text-xl/8 dark:text-neutral-400">Regulaciones y estándares aplicables a la trazabilidad textil.</p>
      </div>
    </div>

    <div class="mx-auto max-w-5xl px-6 lg:px-8">
      <!-- World Map (sticky) -->
      <div class="sticky top-14 z-10 -mx-6 bg-background px-6 pb-4 shadow-[0_8px_6px_-6px] shadow-background sm:top-16 lg:-mx-8 lg:px-8">
        <div id="world-map-container" class="mx-auto max-w-3xl [&_svg]:w-full [&_svg]:h-auto [&_path]:fill-neutral-300 [&_path]:transition-[fill] [&_path]:duration-300 [&_path]:cursor-pointer [&_path]:hover:fill-neutral-400 dark:[&_path]:fill-neutral-700 dark:[&_path]:hover:fill-neutral-500">
          <Fragment set:html={mapSvg} />
        </div>
      </div>

      <!-- Normativas List -->
      <div class="divide-y divide-neutral-200 border-t border-neutral-200 dark:divide-neutral-700 dark:border-neutral-700">
        {normativas.map((normativa) => (
            <div
              class="normativa-row group flex cursor-pointer flex-col gap-3 rounded-lg px-4 py-5 -mx-4 transition-all sm:flex-row sm:items-start sm:gap-6"
              data-regions={JSON.stringify(resolveRegions(normativa.data.region))}
              data-id={normativa.id}
            >
              <div class="min-w-0 flex-1">
                <div class="flex flex-wrap items-center gap-2">
                  <h3 class="text-base font-semibold text-neutral-900 dark:text-white">{normativa.data.title}</h3>
                  {normativa.data.category.map((cat) => {
                    const color = categoryColors[cat] || defaultColor;
                    return (
                      <span class={`inline-flex shrink-0 items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${color.bg} ${color.text}`}>
                        {cat}
                      </span>
                    );
                  })}
                </div>
                <p class="mt-1 text-sm text-neutral-600 dark:text-neutral-400 line-clamp-1">{normativa.data.description}</p>
              </div>
              <div class="flex shrink-0 items-center gap-4">
                <time datetime={normativa.data.date.toISOString()} class="text-sm text-neutral-500 dark:text-neutral-400">
                  {normativa.data.date.toLocaleDateString("es-ES", { year: "numeric", month: "short", day: "numeric" })}
                </time>
                <a
                  href={`/normativas/${normativa.id}`}
                  class="text-sm font-semibold text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300 whitespace-nowrap"
                >
                  Conocer más &rarr;
                </a>
              </div>
            </div>
          ))}
      </div>
    </div>
  </div>
</Layout>

<script>
  const rows = document.querySelectorAll<HTMLDivElement>(".normativa-row");
  const svg = document.querySelector<SVGSVGElement>("#world-map");
  let activeRows: Set<HTMLDivElement> = new Set();
  let activeCountry: string | null = null;

  function getRegions(row: HTMLDivElement): string[] {
    try {
      return JSON.parse(row.dataset.regions || "[]");
    } catch {
      return [];
    }
  }

  function setRegionFill(regions: string[], fill: string | null) {
    const selector = regions
      .map((r) => `#world-map #${CSS.escape(r)}, #world-map #${CSS.escape(r)} path`)
      .join(", ");
    if (!selector) return;
    document.querySelectorAll<SVGElement>(selector).forEach((p) => {
      if (fill) {
        p.style.fill = fill;
      } else {
        p.style.removeProperty("fill");
      }
    });
  }

  function clearAll() {
    activeRows.forEach((row) => {
      row.classList.remove("bg-primary-50", "dark:bg-primary-500/10");
      setRegionFill(getRegions(row), null);
    });
    activeRows.clear();
    if (activeCountry) {
      setRegionFill([activeCountry], null);
      activeCountry = null;
    }
  }

  // Click a normativa row → highlight it + its regions on the map
  rows.forEach((row) => {
    row.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).closest("a")) return;

      const wasActive = activeRows.has(row);
      clearAll();
      if (!wasActive) {
        activeRows.add(row);
        row.classList.add("bg-primary-50", "dark:bg-primary-500/10");
        setRegionFill(getRegions(row), "var(--color-primary-500)");
      }
    });
  });

  // Click a country on the map → highlight it + matching normativas
  svg?.addEventListener("click", (e) => {
    const target = e.target as SVGElement;
    const pathOrGroup = target.closest<SVGElement>("path[id], g[id]");
    if (!pathOrGroup) return;

    const countryId = pathOrGroup.id.toLowerCase();
    const wasSame = activeCountry === countryId;

    clearAll();
    if (wasSame) return;

    activeCountry = countryId;
    setRegionFill([countryId], "var(--color-primary-500)");

    rows.forEach((row) => {
      const regions = getRegions(row);
      if (regions.includes(countryId)) {
        activeRows.add(row);
        row.classList.add("bg-primary-50", "dark:bg-primary-500/10");
      }
    });
  });
</script>
