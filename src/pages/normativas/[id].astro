---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { readFileSync } from "node:fs";
import { resolveRegions, regionDisplayLabels } from "../../regions";

export async function getStaticPaths() {
  const normativas = await getCollection("normativas");
  return normativas.map((normativa) => ({
    params: { id: normativa.id },
    props: { normativa },
  }));
}

const { normativa } = Astro.props;
const { Content } = await render(normativa);

const categoryColors: Record<string, { bg: string; text: string }> = {
  Ambiental: {
    bg: "bg-emerald-50 dark:bg-emerald-500/10",
    text: "text-emerald-700 dark:text-emerald-400",
  },
  Laboral: {
    bg: "bg-blue-50 dark:bg-blue-500/10",
    text: "text-blue-700 dark:text-blue-400",
  },
  Comercial: {
    bg: "bg-amber-50 dark:bg-amber-500/10",
    text: "text-amber-700 dark:text-amber-400",
  },
};

const defaultColor = {
  bg: "bg-neutral-50 dark:bg-neutral-500/10",
  text: "text-neutral-700 dark:text-neutral-400",
};

const categories = normativa.data.category;

const mapSvg = readFileSync("public/world-map.svg", "utf-8");
const resolvedRegions = resolveRegions(normativa.data.region);
const labels = regionDisplayLabels(normativa.data.region);
---

<Layout title={normativa.data.title}>
  <article class="bg-background pt-8 pb-24 sm:pt-12 sm:pb-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <!-- TOC + Content layout -->
      <div class="flex flex-col mx-auto max-w-3xl lg:grid lg:max-w-none lg:grid-cols-[220px_1fr] lg:gap-12 xl:grid-cols-[260px_1fr]">
        <!-- Sidebar TOC (desktop: sticky top sidebar, mobile: sticky bottom) -->
        <nav id="toc-nav" class="order-last sticky bottom-2 z-30 mx-4 rounded-xl border-2 border-primary-500 bg-white/95 backdrop-blur-sm shadow-lg dark:border-primary-400 dark:bg-neutral-900/95 lg:order-none lg:sticky lg:top-20 lg:bottom-auto lg:z-auto lg:mx-0 lg:self-start lg:border lg:border-neutral-200 lg:bg-neutral-50 lg:shadow-none lg:backdrop-blur-none dark:lg:border-neutral-700 dark:lg:bg-neutral-800/50">
          <button
            id="toc-toggle"
            type="button"
            class="flex w-full items-center justify-between p-4 lg:pointer-events-none"
          >
            <h2 class="text-sm font-semibold text-primary-600 lg:text-xs lg:uppercase lg:tracking-wide lg:text-neutral-500 dark:text-primary-400 dark:lg:text-neutral-400">Contenido</h2>
            <svg id="toc-chevron" class="size-5 text-primary-500 transition-transform duration-200 dark:text-primary-400 lg:hidden" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 0 1-1.06-.02L10 8.832 6.29 12.77a.75.75 0 1 1-1.08-1.04l4.25-4.5a.75.75 0 0 1 1.08 0l4.25 4.5a.75.75 0 0 1-.02 1.06Z" clip-rule="evenodd" />
            </svg>
          </button>
          <ul id="toc-list" class="hidden space-y-2 px-4 pb-4 text-sm max-h-[40vh] overflow-y-auto lg:block lg:mt-0 lg:max-h-[calc(100vh-8rem)]"></ul>
        </nav>

        <!-- Main content -->
        <div class="min-w-0">
          <!-- Header -->
          <div class="mb-12">
            <a href="/normativas" class="text-sm/6 font-semibold text-primary-600 dark:text-primary-400">&larr; Volver a normativas</a>
            <div class="mt-6 flex flex-wrap items-center gap-3">
              {categories.map((cat) => {
                const color = categoryColors[cat] || defaultColor;
                return (
                  <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${color.bg} ${color.text}`}>
                    {cat}
                  </span>
                );
              })}
              <time datetime={normativa.data.date.toISOString()} class="text-sm text-neutral-500 dark:text-neutral-400">
                {normativa.data.date.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" })}
              </time>
            </div>
            <h1 class="mt-4 text-3xl font-semibold tracking-tight text-neutral-900 sm:text-4xl dark:text-white">{normativa.data.title}</h1>
            <p class="mt-4 text-lg/8 text-neutral-600 dark:text-neutral-400">{normativa.data.description}</p>
          </div>

          <!-- Region map -->
          <div class="mb-12">
            <h2 class="text-center text-xs font-semibold uppercase tracking-wide text-neutral-500 dark:text-neutral-400">Aplica en</h2>
            <div class="mt-2 flex flex-wrap justify-center gap-2">
              {labels.map((label) => (
                <span class="inline-flex items-center rounded-full bg-primary-50 px-2.5 py-0.5 text-xs font-medium text-primary-700 dark:bg-primary-500/10 dark:text-primary-400">
                  {label}
                </span>
              ))}
            </div>
            <div
              id="detail-map"
              class="mx-auto mt-4 max-w-xs [&_svg]:w-full [&_svg]:h-auto [&_path]:fill-neutral-300 dark:[&_path]:fill-neutral-700"
              data-regions={JSON.stringify(resolvedRegions)}
            >
              <Fragment set:html={mapSvg} />
            </div>
          </div>

          <div id="normativa-content" class="prose prose-lg max-w-none dark:prose-invert prose-headings:scroll-mt-20 prose-headings:text-neutral-900 dark:prose-headings:text-white prose-p:text-justify prose-p:text-neutral-600 dark:prose-p:text-neutral-400 prose-a:text-primary-600 dark:prose-a:text-primary-400">
            <Content />
          </div>

          <div class="mt-12 mb-20 lg:mb-0">
            <a href="/normativas" class="text-sm/6 font-semibold text-primary-600 dark:text-primary-400">&larr; Volver a normativas</a>
          </div>
        </div>
      </div>
    </div>
  </article>

  <script>
    function buildTOC() {
      const content = document.getElementById("normativa-content");
      const tocList = document.getElementById("toc-list");
      if (!content || !tocList) return;

      const headings = content.querySelectorAll("h2, h3");
      if (headings.length === 0) {
        const nav = document.getElementById("toc-nav");
        if (nav) nav.style.display = "none";
        return;
      }

      headings.forEach((heading, i) => {
        if (!heading.id) {
          heading.id = `heading-${i}`;
        }

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent;
        a.className =
          heading.tagName === "H3"
            ? "block pl-3 text-neutral-500 hover:text-neutral-900 dark:text-neutral-500 dark:hover:text-white"
            : "block font-medium text-neutral-700 hover:text-neutral-900 dark:text-neutral-300 dark:hover:text-white";
        li.appendChild(a);
        tocList.appendChild(li);
      });
    }

    buildTOC();

    // TOC toggle (mobile)
    const tocToggle = document.getElementById("toc-toggle");
    const tocList = document.getElementById("toc-list");
    const tocChevron = document.getElementById("toc-chevron");

    tocToggle?.addEventListener("click", () => {
      tocList?.classList.toggle("hidden");
      tocList?.classList.toggle("lg:block");
      tocChevron?.classList.toggle("rotate-180");
    });

    // Close TOC on mobile after clicking a link
    tocList?.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).closest("a") && window.innerWidth < 1024) {
        tocList.classList.add("hidden");
        tocChevron?.classList.remove("rotate-180");
      }
    });

    // Highlight regions on the detail map
    const mapContainer = document.getElementById("detail-map");
    if (mapContainer) {
      const regions: string[] = JSON.parse(mapContainer.dataset.regions || "[]");
      const svg = mapContainer.querySelector("svg");
      if (svg && regions.length) {
        const selector = regions
          .map((r) => `#${CSS.escape(r)}, #${CSS.escape(r)} path`)
          .join(", ");
        svg.querySelectorAll<SVGElement>(selector).forEach((p) => {
          p.style.fill = "var(--color-primary-500)";
        });
      }
    }
  </script>
</Layout>
